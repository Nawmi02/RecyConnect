{% extends "Admin/admin_base.html" %}
{% load static %}

{% block title %}Learn · RecyConnect{% endblock %}

{% block content %}
<style>
  .ln-wrap{ max-width:1200px; margin:0 auto; padding:8px 6px 24px; }
  .ln-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
  .ln-title{ font-size:20px; font-weight:800; color:#065f46 }
  .btn-add{
    display:inline-flex; align-items:center; gap:8px;
    background:#16a34a; color:#fff; font-weight:700; border:none; cursor:pointer;
    padding:10px 14px; border-radius:999px; text-decoration:none;
  }
  .btn-add:hover{ filter:brightness(.95) }

  /* Grid of cards */
  .ln-grid{ display:grid; gap:16px; grid-template-columns:repeat(3, minmax(0,1fr)); }
  @media (max-width:1024px){ .ln-grid{ grid-template-columns:repeat(2,1fr); } }
  @media (max-width:640px){ .ln-grid{ grid-template-columns:1fr; } }

  .card{
    background:#fff; border:1px solid #e5e7eb; border-radius:16px;
    box-shadow:0 8px 26px rgba(0,0,0,.06); overflow:hidden;
    display:flex; flex-direction:column;
  }
  .thumb{ width:100%; height:160px; object-fit:cover; background:#f8fafc }
  .body{ padding:14px }
  .title{ font-size:16px; font-weight:800; color:#111827; margin-bottom:6px }
  .meta{ display:flex; align-items:center; gap:10px; font-size:12px; color:#6b7280; margin-bottom:8px }
  .badge{
    display:inline-flex; align-items:center; padding:4px 10px; border-radius:999px;
    font-size:12px; font-weight:700; border:1px solid #e5e7eb; background:#f9fafb; color:#065f46;
  }
  .desc{ font-size:14px; color:#374151; line-height:1.5; margin-bottom:10px }
  .tags{ display:flex; flex-wrap:wrap; gap:8px; margin-top:4px }
  .tag{
    font-size:11px; font-weight:700; padding:4px 8px; border-radius:999px;
    background:#eef2ff; color:#3730a3; border:1px solid #e0e7ff;
  }
  .row-actions{ display:flex; gap:8px; padding:0 14px 14px; margin-top:auto }
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    padding:9px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; text-decoration:none; color:#111827; font-weight:600;
  }
  .btn:hover{ background:#f8fafc }

  .msgs{ margin:8px 0 12px 0; }
  .msg{ padding:10px 12px; border-radius:10px; font-weight:600; margin-bottom:6px; }
  .msg-ok{ background:#eaf7ef; color:#065f46; border:1px solid #bbf7d0 }
  .msg-err{ background:#fee2e2; color:#991b1b; border:1px solid #fecaca }

  /* Tag chips (checkbox) */
  .chips{ display:flex; flex-wrap:wrap; gap:8px; }
  .chip {
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
    border-radius:999px; border:1px solid #e5e7eb; cursor:pointer; user-select:none;
    font-size:12px; font-weight:700; color:#374151; background:#fff;
    transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
  }
  .chip input{ appearance:none; width:14px; height:14px; border:1px solid #9ca3af; border-radius:4px; display:inline-block; }
  .chip input:checked{ background:#16a34a; border-color:#16a34a; box-shadow:inset 0 0 0 2px #fff; }
  .chip.active{ border-color:#16a34a; background:#f0fdf4; box-shadow:0 0 0 3px rgba(22,163,74,.15); }

  /* Modal overlay + scrollable modal */
  .overlay{
    position: fixed; inset:0; z-index:60; display:none;
    overflow-y: auto; /* scrollable */
  }
  .overlay.open{ display:block; }
  .backdrop{
    position:absolute; inset:0; background: rgba(0,0,0,.35);
    backdrop-filter: blur(4px);
  }
  .sheet{
    position: relative; margin:40px auto; max-width:860px; display:flex; flex-direction:column; z-index:10;
  }
  .modal{
    background:#fff; border:1px solid #22c55e; border-radius:16px;
    box-shadow:0 16px 38px rgba(0,0,0,.14);
    display:flex; flex-direction:column;
    max-height: 90vh; /* screen height er 90% */
    overflow-y: auto;
  }
  .md-head{ padding:14px 16px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; flex-shrink:0; }
  .md-title{ font-size:18px; font-weight:800; color:#065f46 }
  .md-body{ padding:16px; flex: 1 1 auto; }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
  @media (max-width:760px){ .grid-2{ grid-template-columns:1fr; } }
  .lbl{ font-size:13px; font-weight:700; color:#374151; margin-bottom:6px }
  .inp, .txt, .sel{
    width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; outline:none; font-size:14px;
  }
  .inp:focus, .txt:focus, .sel:focus{ border-color:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.15) }
  .help{ font-size:12px; color:#6b7280; margin-top:4px }
  .md-actions{
    display:flex; justify-content:flex-end; gap:10px; padding:16px;
    flex-shrink:0; background:#f9fafb; border-top:1px solid #e5e7eb;
    position: sticky; bottom:0; z-index:5;
  }
  .btn-cancel{
    border:1px solid #e5e7eb; background:#fff; color:#111827; border-radius:999px; padding:10px 16px; font-weight:700; cursor:pointer;
  }
  .btn-submit{
    border:none; background:#16a34a; color:#fff; border-radius:999px; padding:10px 18px; font-weight:800; cursor:pointer;
  }
  .btn-cancel:hover{ background:#f8fafc }
  .btn-submit:hover{ filter:brightness(.95) }
</style>

<div class="ln-wrap">
  <div class="ln-head">
    <div class="ln-title">Learn Library</div>
    <button id="openModalBtn" class="btn-add">+ Add Content</button>
  </div>

  {% if messages %}
    <div class="msgs">
      {% for m in messages %}
        <div class="msg {% if m.tags == 'success' %}msg-ok{% else %}msg-err{% endif %}">{{ m }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Content grid -->
  <div class="ln-grid">
    {% for item in learns %}
      <article class="card">
        {% if item.image %}
          <img class="thumb" src="{{ item.image.url }}" alt="">
        {% else %}
          <img class="thumb" src="{% static 'placeholders/learn-cover.png' %}" alt="">
        {% endif %}

        <div class="body">
          <div class="title">{{ item.title }}</div>
          <div class="meta">
            <span class="badge">{{ item.get_category_display }}</span>
            <span>• {{ item.read_time }} min</span>
            <span>• {{ item.created_at|date:"M d, Y" }}</span>
          </div>
          {% if item.topic %}
            <div class="meta" style="margin-top:-2px"><strong>Topic:</strong>&nbsp;{{ item.topic }}</div>
          {% endif %}
          <div class="desc">{{ item.description|truncatechars:140 }}</div>

          {% with qs=item.tags.all %}
            {% if qs %}
              <div class="tags">
                {% for t in qs %}
                  <span class="tag">{{ t.get_name_display }}</span>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
        </div>

        <div class="row-actions">
          {% if item.category == "guideline" or item.category == "article" %}
            {% if item.pdf_file %}<a class="btn" href="{{ item.pdf_file.url }}" target="_blank">Open PDF</a>{% endif %}
          {% elif item.category == "video" %}
            {% if item.video_file %}<a class="btn" href="{{ item.video_file.url }}" target="_blank">Play Video</a>{% endif %}
          {% elif item.category == "quick_text" %}
            <a class="btn" href="#" onclick="alert({{ item.quick_text|escapejs }}); return false;">Read Text</a>
          {% endif %}
        </div>
      </article>
    {% empty %}
      <div class="card" style="grid-column:1/-1; padding:18px">
        <div class="title" style="font-size:16px">No content yet. Click “Add Content”.</div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Modal -->
<div id="modal" class="overlay" aria-hidden="true">
  <div id="modalBackdrop" class="backdrop"></div>
  <div class="sheet">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mdTitle">
      <div class="md-head">
        <div id="mdTitle" class="md-title">Add Learn Content</div>
        <button id="closeModalBtn" class="btn-cancel" type="button">✕</button>
      </div>

      <form class="md-body" method="post" enctype="multipart/form-data" action="{% url 'adminpanel:learn' %}">
        {% csrf_token %}
        <div class="grid-2">
          <div>
            <div class="lbl">Title</div>
            <input class="inp" name="title" type="text" required placeholder="Title">
          </div>
          <div>
            <div class="lbl">Topic </div>
            <input class="inp" name="topic" type="text" required placeholder="Topic">
          </div>
        </div>

        <div class="grid-2" style="margin-top:10px">
          <div>
            <div class="lbl">Category</div>
            <select id="catSelect" class="sel" name="category" required>
              {% for val,label in cat_choices %}
                <option value="{{ val }}">{{ label }}</option>
              {% endfor %}
            </select>
            <div class="help">Guideline/Article → PDF • Video → video file • Quick Text → text</div>
          </div>
          <div>
            <div class="lbl">Read time (min)</div>
            <input class="inp" name="read_time" type="number" min="1" step="1" value="3" required>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="lbl">Short Description</div>
          <textarea class="txt" name="description" rows="3" required placeholder="One or two lines about the content"></textarea>
        </div>

        <div class="grid-2" style="margin-top:10px">
          <div>
            <div class="lbl">Cover Image (optional)</div>
            <input class="inp" type="file" name="image" accept="image/*">
          </div>

          <div>
            <div class="lbl">Tags (multi-select)</div>
            <div class="chips" id="tagChips">
              {% for code,label in tag_opts %}
                <label class="chip">
                  <input type="checkbox" name="tag_codes" value="{{ code }}">
                  <span>{{ label }}</span>
                </label>
              {% endfor %}
            </div>
            <div class="help">You can pick multiple tags.</div>
          </div>
        </div>

        <!-- Conditional fields -->
        <div id="pdfRow" style="margin-top:10px; display:none">
          <div class="lbl">PDF file</div>
          <input class="inp" type="file" name="pdf_file" accept="application/pdf">
        </div>

        <div id="videoRow" style="margin-top:10px; display:none">
          <div class="lbl">Video file</div>
          <input class="inp" type="file" name="video_file" accept="video/*">
        </div>

        <div id="quickRow" style="margin-top:10px; display:none">
          <div class="lbl">Quick Text</div>
          <textarea class="txt" name="quick_text" rows="4" placeholder="Write the quick text content here"></textarea>
        </div>

        <div class="md-actions">
          <button id="cancelBtn" type="button" class="btn-cancel">Cancel</button>
          <button type="submit" class="btn-submit">Add</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('modal');
  const openBtn = document.getElementById('openModalBtn');
  const closeBtn = document.getElementById('closeModalBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const backdrop = document.getElementById('modalBackdrop');

  function open(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
  function close(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }

  openBtn.addEventListener('click', open);
  if (closeBtn) closeBtn.addEventListener('click', close);
  if (cancelBtn) cancelBtn.addEventListener('click', close);
  backdrop.addEventListener('click', close);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });

  // Category-driven field toggle
  const cat = document.getElementById('catSelect');
  const pdfRow = document.getElementById('pdfRow');
  const videoRow = document.getElementById('videoRow');
  const quickRow = document.getElementById('quickRow');

  function syncFields(){
    const v = cat.value;
    pdfRow.style.display = (v==='guideline' || v==='article') ? 'block':'none';
    videoRow.style.display = (v==='video') ? 'block':'none';
    quickRow.style.display = (v==='quick_text') ? 'block':'none';
  }
  cat.addEventListener('change', syncFields);
  syncFields();

  // Chip active style toggle
  const chipWrap = document.getElementById('tagChips');
  if (chipWrap) {
    chipWrap.addEventListener('change', (e) => {
      if (e.target && e.target.type === 'checkbox') {
        const label = e.target.closest('.chip');
        if (!label) return;
        if (e.target.checked) label.classList.add('active');
        else label.classList.remove('active');
      }
    });
  }
})();
</script>
{% endblock %}
